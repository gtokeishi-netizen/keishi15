# 🚀 市町村システム デプロイメントガイド

## 📦 Step 1: ファイル準備

### 必要なファイル
- ✅ `functions.php` - メイン機能とフックの定義
- ✅ `style.css` - テーマスタイル定義
- ✅ `index.php` - メインテンプレート
- ✅ `archive-grant.php` - 助成金一覧ページ（市町村システム統合済み）
- ✅ `/inc/theme-foundation.php` - 基盤システム（市町村マスターデータ含む）
- ✅ `/inc/admin-functions.php` - 管理画面機能（メタボックス）
- ✅ `/inc/ajax-functions.php` - AJAX処理（市町村動的ロード）
- ✅ `/assets/js/admin-consolidated.js` - 管理画面JavaScript

## 🛠️ Step 2: WordPressサイトへの適用

### 2-1. テーマアップロード方法

#### 方法A: FTP/cPanelでのアップロード
```bash
# FTPクライアントで以下のディレクトリにアップロード：
/public_html/wp-content/themes/grant-insight-perfect/

# または cPanel ファイルマネージャーで：
# wp-content/themes/ に新フォルダー「grant-insight-perfect」を作成
# 全ファイルをアップロード
```

#### 方法B: WordPress管理画面（ZIP形式）
```bash
# 1. 全ファイルをZIPに圧縮
# 2. WordPress管理画面 → 外観 → テーマ → 新規追加 → テーマのアップロード
# 3. ZIPファイルを選択してインストール
```

### 2-2. テーマのアクティベーション
1. WordPress管理画面にログイン
2. **外観** → **テーマ** に移動
3. **Grant Insight Perfect** テーマを選択
4. **有効化** ボタンをクリック

## ⚡ Step 3: 自動初期化（テーマ有効化時）

### 自動実行される処理
- ✅ カスタム投稿タイプ `grant` の登録
- ✅ カスタムタクソノミーの作成（prefecture, municipality, category）
- ✅ **47都道府県** × **全市町村** のマスターデータ自動生成
- ✅ パーマリンク構造の更新
- ✅ 必要なオプションとデータベーステーブルの初期化

### アクティベーション後の確認
1. **左メニューに「助成金」が表示** されることを確認
2. **助成金 → 都道府県** でタクソノミーが作成されていることを確認
3. **助成金 → 市町村** で全国の市町村データが生成されていることを確認

## 🧪 Step 4: 動作確認とテスト

### 4-1. 管理画面でのテスト
1. **助成金 → 新規追加** を開く
2. 右側メタボックスで「地域制限設定」を確認
3. **市町村レベル** を選択
4. **都道府県**（例：東京都）をチェック
5. → **市町村リストが動的に表示される** ことを確認

### 4-2. フロントエンド動作確認
1. `/grant/` ページにアクセス
2. 都道府県フィルターで任意の県を選択
3. → **市町村フィルターが動的更新** されることを確認
4. 検索結果が正しく絞り込まれることを確認

### 4-3. AJAX機能の確認
ブラウザのF12開発者ツールで：
- Network タブを開く
- 都道府県を選択
- `gi_ajax_get_municipalities_for_prefectures` リクエストが送信される
- 市町村データが正常に返される

## 🔧 Step 5: カスタマイズと設定

### 5-1. ACF（Advanced Custom Fields）の設定
テーマに ACF設定が含まれているため、プラグインインストール後に：
1. **カスタムフィールド → フィールドグループ** を確認
2. 「助成金情報」フィールドグループが自動で作成される

### 5-2. 地域制限タイプの設定
各助成金で以下のオプションを選択可能：
- **全国対象**: 地域制限なし
- **都道府県レベル**: 指定した都道府県のみ対象
- **市町村レベル**: 指定した市町村のみ対象

## 🎯 Step 6: 本格運用

### 6-1. 助成金データの作成
1. **助成金 → 新規追加**
2. 基本情報を入力：
   - タイトル
   - 内容
   - 助成金額
   - 締切日
3. **地域制限設定**:
   - 対象レベルを選択
   - 都道府県/市町村を指定
4. **カテゴリー選択**
5. **公開** ボタンをクリック

### 6-2. ユーザー向け検索機能
- 地域別検索（都道府県 → 市町村の階層選択）
- カテゴリー別フィルタリング
- 金額範囲での絞り込み
- キーワード検索

## 🛡️ Step 7: トラブルシューティング

### 問題A: 市町村データが表示されない
**解決策:**
1. **設定 → パーマリンク → 保存** で更新
2. テーマの再アクティベーション
3. ブラウザキャッシュのクリア

### 問題B: AJAX が動作しない
**解決策:**
1. jQueryが読み込まれているか確認
2. wp_head()とwp_footer()がテンプレートに含まれているか確認
3. wp-config.phpでデバッグモード有効化：
   ```php
   define('WP_DEBUG', true);
   define('WP_DEBUG_LOG', true);
   ```

### 問題C: CSS/JSが読み込まれない
**解決策:**
1. functions.phpのwp_enqueue_style/scriptを確認
2. ファイルパスが正しいか確認
3. ブラウザの開発者ツールでネットワークエラーを確認

## 📈 Step 8: パフォーマンス最適化

### キャッシュプラグインとの互換性
- WP Rocket
- W3 Total Cache
- WP Super Cache

### データベース最適化
- 不要な市町村タームの削除
- 定期的なデータベースクリーンアップ

## 🎉 完了！

これで本格的な市町村システムが完全に動作します：

- ✅ **47都道府県の完全な市町村マスターデータ**
- ✅ **動的な階層選択インターフェース**
- ✅ **リアルタイムフィルタリング**
- ✅ **管理者向け直感的操作**
- ✅ **高速検索とAJAX統合**

全機能が既存ファイルの改良によって実現され、追加のプラグインやファイル作成不要で即座に利用可能です！